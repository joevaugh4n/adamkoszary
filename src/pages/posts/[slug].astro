---
import Post from "../../layouts/Post.astro";
import Tag from "../../components/Tag.astro";
import { getImage } from "astro:assets";
import { fetchPosts, fetchTags } from "../../lib/wordpress";

export async function getStaticPaths() {
  const posts = await fetchPosts();
  const tags = await fetchTags();

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, tags },
  }));
}

const { post, tags } = Astro.props;

// Create a map of tag IDs to tag names
const tagMap = new Map<number, string>(
  Object.values(tags).map((tag) => [tag.id, tag.name])
);

// Format date
function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Get optimized image URL
const heroImage = post.featured_media?.source_url ? await getImage({
  src: post.featured_media.source_url,
  width: 1600,
  height: 900,
}) : null;
---

<head>
  {heroImage && (
    <link rel="preload" as="image" href={heroImage.src} />
  )}
</head>

<Post title={post.title.rendered} description={post.excerpt.rendered}>
  <article class="max-w-3xl mx-auto py-8">
    {heroImage && (
      <div class="mb-8 relative" style={{ paddingBottom: "56.25%" }}>
        <div 
          class="absolute inset-0 w-full h-full object-cover rounded-sm" 
          style={`background-image: url(${heroImage.src}); background-size: cover; background-position: center;`}
        ></div>
      </div>
    )}

    <hgroup>
      <h1 class="text-4xl uppercase mb-4">{post.title.rendered}</h1>
      <p class="text-gray-600 dark:text-white mb-4">{formatDate(post.date)}</p>

      <div class="mb-6 flex gap-2 flex-wrap">
        {post.tags.map((tagId) => {
          const tagName = tagMap.get(tagId);
          return tagName ? <Tag tag={tagName} /> : null;
        })}
      </div>
    </hgroup>

    <div
      class="prose prose-lg dark:prose-invert"
      set:html={post.content.rendered}
    />
  </article>
</Post>